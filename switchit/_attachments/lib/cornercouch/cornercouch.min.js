angular.module("CornerCouch",["ng"]).factory("cornercouch",["$http",function(g){var c=angular;function f(h){if(h.method==="JSONP"){if(h.params){h.params.callback="JSON_CALLBACK";
}else{h.params={callback:"JSON_CALLBACK"};}}return h;}function e(j,k,i){var h=j;if(k){h=h+"/"+encodeURIComponent(k);}if(i){h=h+"/"+encodeURIComponent(i);
}return h.replace("%2F","/");}function d(j,i,l){var h=e(i,j);function k(m){c.copy(m||{},this);}k.prototype.load=function(p,m){var n={method:l,url:e(h,p||this._id)};
if(m){n.params=m;}var o=this;return g(f(n)).success(function(q){c.copy(q,o);});};k.prototype.save=function(){var m;if(this._id){m={method:"PUT",url:e(h,this._id)};
}else{m={method:"POST",url:h};}var n=m.data=this;return g(m).success(function(o){if(o.id){n._id=o.id;}if(o.rev){n._rev=o.rev;}});};k.prototype.remove=function(){return g({method:"DELETE",url:e(h,this._id),params:{rev:this._rev}});
};k.prototype.attach=function(o,n,m){var p=this;if(c.isFunction(n)){m=n;n=null;}return g({method:"PUT",url:e(h,p._id,n||o.name),params:{rev:p._rev},headers:{"Content-Type":o.type},data:o}).success(function(){p.load().success(m||c.noop);
});};k.prototype.attachMulti=function(p,o){var q=this;var n=0;function m(){if(n<p.length){q.attach(p[n],++n<p.length?m:o);}}m();};k.prototype.detach=function(m){var n=this;
return g({method:"DELETE",url:e(h,n._id,m),params:{rev:n._rev}}).success(function(){n.load();});};k.prototype.attachUri=function(m){return e(h,this._id,m);
};this.docClass=k;this.uri=h;this.method=l;this.rows=[];this.prevRows=[];this.nextRow=null;this.queryActive=false;}d.prototype.getInfo=function(){var h=this;
return g({method:"GET",url:this.uri+"/"}).success(function(i){h.info=i;});};d.prototype.newDoc=function(h){return new this.docClass(h);};d.prototype.getDoc=function(i){var h=new this.docClass();
h.load(i);return h;};d.prototype.getQueryDoc=function(h){var j=this.rows[h];if(!j.doc){return this.getDoc(j.id);}var i=j.doc;if(i instanceof this.docClass){return i;
}i=this.newDoc(i);j.doc=i;return i;};function b(h){h.queryActive=true;return g(h.qConfig).success(function(m,l,n,j){if(j.params&&j.params.limit){if(m.rows.length===j.params.limit){h.nextRow=m.rows.pop();
}else{h.nextRow=null;}}if(j.append){for(var k in m.rows){h.rows.push(m.rows[k]);}delete h.qConfig.append;}else{h.rows=m.rows;}h.queryActive=false;}).error(function(){h.queryActive=false;
});}d.prototype.queryView=function(i,k){var h={method:this.method,url:this.uri+i};if(k){if(k.limit){k.limit++;}for(var j in k){switch(j){case"key":case"keys":case"startkey":case"endkey":k[j]=c.toJson(k[j]);
}}h.params=k;}this.qConfig=f(h);return b(this);};d.prototype.query=function(i,h,j){return this.queryView("/_design/"+encodeURIComponent(i)+"/_view/"+encodeURIComponent(h),j);
};d.prototype.list=function(i,j,h,k){return this.queryView("/_design/"+encodeURIComponent(i)+"/_list/"+encodeURIComponent(j)+"/"+encodeURIComponent(h),k);
};d.prototype.queryAll=function(h){return this.queryView("/_all_docs",h);};d.prototype.queryRefresh=function(){return b(this);};d.prototype.queryNext=function(){var h=this.nextRow;
if(h&&!this.queryActive){this.prevRows.push(this.rows[0]);this.qConfig.params.startkey=c.toJson(h.key);if(h.id&&h.id!==h.key){this.qConfig.params.startkey_docid=h.id;
}return b(this);}else{return null;}};d.prototype.queryMore=function(){var h=this.nextRow;if(h&&!this.queryActive){this.qConfig.params.startkey=c.toJson(h.key);
if(h.id&&h.id!==h.key){this.qConfig.params.startkey_docid=h.id;}this.qConfig.append=true;return b(this);}else{return null;}};d.prototype.queryPrev=function(){var h=this.prevRows.pop();
if(h&&!this.queryActive){this.qConfig.params.startkey=c.toJson(h.key);if(h.id&&h.id!==h.key){this.qConfig.params.startkey_docid=h.id;}return b(this);}else{return null;
}};function a(h,i){if(h){this.uri=h;this.method=i||"JSONP";if(this.method!=="JSONP"){g.defaults.withCredentials=true;}}else{this.uri="";this.method="GET";
}}a.prototype.getDB=function(h){return new d(h,this.uri,this.method);};a.prototype.getUserDB=function(){if(!this.userDB){this.userDB=this.getDB("_users");
}return this.userDB;};a.prototype.getUserDoc=function(){var h=this.getUserDB();if(this.userCtx.name){this.userDoc=h.getDoc("org.couchdb.user:"+this.userCtx.name);
}else{this.userDoc=h.newDoc();}return this.userDoc;};a.prototype.getInfo=function(){var h=this;return g({method:"GET",url:this.uri+"/"}).success(function(i){h.info=i;
});};a.prototype.getDatabases=function(){var h=this;return g({method:"GET",url:this.uri+"/_all_dbs"}).success(function(i){h.databases=i;});};a.prototype.createDB=function(h){var i=this;
return g({method:"PUT",url:e(i.uri,h)}).success(function(){if(i.databases){i.databases.push(h);}});};a.prototype.session=function(){var h=this;return g({method:"GET",url:this.uri+"/_session"}).success(function(i){h.userCtx=i.userCtx;
});};a.prototype.login=function(l,k){var h="name="+encodeURIComponent(l)+"&password="+encodeURIComponent(k);var j=this;var i=l;return g({method:"POST",url:this.uri+"/_session",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:h.replace(/%20/g,"+")}).success(function(m){delete m.ok;
j.userCtx=m;j.userCtx.name=i;});};a.prototype.logout=function(){var h=this;return g({method:"DELETE",url:this.uri+"/_session"}).success(function(){h.userCtx={name:null,roles:[]};
h.userDoc={};});};a.prototype.getUUIDs=function(h){var i=this;return g({method:"GET",url:this.uri+"/_uuids",params:{count:h||1}}).success(function(j){i.uuids=j.uuids;
});};return function(h,i){return new a(h,i);};}]);